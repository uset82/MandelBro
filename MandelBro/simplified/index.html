<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MandelBro - Kids Game Creator</title>
    <style>
        :root {
            --primary-color: #4a6bff;
            --secondary-color: #ff6b4a;
            --background-color: #f0f4ff;
            --card-color: #ffffff;
            --text-color: #333333;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --error-color: #F44336;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
        }

        .card {
            background-color: var(--card-color);
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        h1, h2, h3 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 30px;
        }

        h2 {
            font-size: 1.8rem;
        }

        h3 {
            font-size: 1.4rem;
        }

        p {
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .btn {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-align: center;
            text-decoration: none;
            margin: 10px 5px;
        }

        .btn:hover {
            background-color: #3a5bef;
            transform: scale(1.05);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: #e55a3a;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #3d9c40;
        }

        .btn-large {
            font-size: 1.2rem;
            padding: 15px 40px;
        }

        .btn-icon {
            margin-right: 8px;
            font-size: 1.2em;
        }

        .screen {
            display: none;
            width: 100%;
        }

        .screen.active {
            display: block;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        .menu-buttons .btn {
            width: 250px;
            max-width: 100%;
        }

        .avatar-selection {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 3px solid transparent;
        }

        .avatar-option:hover {
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(74, 107, 255, 0.5);
        }

        .avatar-shape {
            width: 40px;
            height: 40px;
        }

        .circle {
            border-radius: 50%;
        }

        .square {
            border-radius: 5px;
        }

        .triangle {
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }

        .star {
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
        }

        .red {
            background-color: #ff4a4a;
        }

        .blue {
            background-color: #4a6bff;
        }

        .green {
            background-color: #4aff6b;
        }

        .yellow {
            background-color: #ffde4a;
        }

        .purple {
            background-color: #9c4aff;
        }

        .orange {
            background-color: #ff9c4a;
        }

        .pink {
            background-color: #ff4a9c;
        }

        .teal {
            background-color: #4affde;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .char-counter {
            text-align: right;
            font-size: 0.9rem;
            color: #777;
            margin-top: 5px;
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .chip {
            background-color: #e0e7ff;
            color: var(--primary-color);
            border-radius: 50px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .chip:hover {
            background-color: #c5d1ff;
        }

        .voice-input {
            position: relative;
            margin-top: 10px;
        }

        .voice-btn {
            position: absolute;
            right: 15px;
            bottom: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .voice-btn:hover {
            background-color: #3a5bef;
            transform: scale(1.1);
        }

        .voice-btn.recording {
            animation: pulse 1.5s infinite;
            background-color: var(--error-color);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        .tooltip {
            position: absolute;
            bottom: -30px;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            white-space: nowrap;
        }

        .voice-btn:hover .tooltip {
            opacity: 1;
        }

        .loading-container {
            text-align: center;
            padding: 40px 20px;
        }

        .loading-title {
            font-size: 2rem;
            margin-bottom: 30px;
            color: var(--primary-color);
        }

        .creation-steps {
            max-width: 500px;
            margin: 0 auto 30px;
        }

        .step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .step.current {
            opacity: 1;
        }

        .step.completed {
            opacity: 0.8;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .step-icon img {
            width: 24px;
            height: 24px;
        }

        .step-content {
            flex-grow: 1;
        }

        .step-title {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .step-description {
            font-size: 0.9rem;
            color: #666;
        }

        .loading-bar-container {
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .loading-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 5px;
        }

        .loading-tip {
            font-style: italic;
            color: #666;
        }

        .cancel-btn {
            margin-top: 20px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .cancel-btn:hover {
            background-color: #d32f2f;
        }

        .game-container {
            width: 100%;
            height: 70vh;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #game-canvas {
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }

        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .world-info {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px 15px;
            border-radius: 10px;
        }

        .menu-button {
            background-color: rgba(255, 255, 255, 0.8);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .menu-button:hover {
            background-color: rgba(255, 255, 255, 1);
        }

        .game-menu {
            position: absolute;
            top: 60px;
            right: 15px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 15px;
            z-index: 10;
        }

        .game-menu.hidden {
            display: none;
        }

        .menu-item {
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }

        .menu-item:hover {
            background-color: #f0f0f0;
        }

        .player-list-container {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 10px;
            max-width: 200px;
        }

        .player-list-header {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }

        .player-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .player-avatar {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .player-name {
            font-size: 0.9rem;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .invite-code {
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 3px;
            margin: 20px 0;
            color: var(--primary-color);
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .template-card {
            background-color: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 3px solid transparent;
        }

        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .template-card.selected {
            border-color: var(--primary-color);
        }

        .template-image {
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .template-image img {
            max-width: 80px;
            max-height: 80px;
        }

        .template-info {
            padding: 15px;
        }

        .template-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .template-description {
            font-size: 0.9rem;
            color: #666;
        }

        .blocky-world {
            background-color: #7cb342;
        }

        .sky-defender {
            background-color: #64b5f6;
        }

        .speed-racers {
            background-color: #ef5350;
        }

        .arcade-classic {
            background-color: #9c27b0;
        }

        .ocean-explorer {
            background-color: #00bcd4;
        }

        .galaxy-explorer {
            background-color: #3f51b5;
        }

        .template-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .mandelbrot-canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .control-btn:hover {
            background-color: rgba(255, 255, 255, 1);
        }

        @media (max-width: 768px) {
            .card {
                padding: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.5rem;
            }

            .btn {
                padding: 10px 20px;
            }

            .avatar-option {
                width: 50px;
                height: 50px;
            }

            .avatar-shape {
                width: 30px;
                height: 30px;
            }

            .game-container {
                height: 60vh;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        /* Loading animation */
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(74, 107, 255, 0.2);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="screen active">
        <h1>MandelBro</h1>
        <div class="loading-spinner"></div>
        <p>Loading your adventure...</p>
    </div>

    <!-- Main Menu -->
    <div id="main-menu" class="screen">
        <div class="container">
            <h1>MandelBro</h1>
            <p class="text-center">Create and explore amazing worlds with your friends!</p>
            
            <div class="menu-buttons">
                <button id="create-world-btn" class="btn btn-primary btn-large">
                    <span class="btn-icon">🌍</span> Create New World
                </button>
                <button id="template-world-btn" class="btn btn-secondary">
                    <span class="btn-icon">🧩</span> Use Template World
                </button>
                <button id="join-world-btn" class="btn">
                    <span class="btn-icon">👪</span> Join Friend's World
                </button>
            </div>
        </div>
    </div>

    <!-- Create World Screen -->
    <div id="create-world-screen" class="screen">
        <div class="container">
            <h1>Create Your World</h1>
            
            <div class="card">
                <h2>Choose Your Character</h2>
                <div class="avatar-selection">
                    <div class="avatar-option selected" data-shape="circle" data-color="red">
                        <div class="avatar-shape circle red"></div>
                    </div>
                    <div class="avatar-option" data-shape="square" data-color="blue">
                        <div class="avatar-shape square blue"></div>
                    </div>
                    <div class="avatar-option" data-shape="triangle" data-color="green">
                        <div class="avatar-shape triangle green"></div>
                    </div>
                    <div class="avatar-option" data-shape="star" data-color="yellow">
                        <div class="avatar-shape star yellow"></div>
                    </div>
                    <div class="avatar-option" data-shape="circle" data-color="purple">
                        <div class="avatar-shape circle purple"></div>
                    </div>
                    <div class="avatar-option" data-shape="square" data-color="orange">
                        <div class="avatar-shape square orange"></div>
                    </div>
                    <div class="avatar-option" data-shape="circle" data-color="pink">
                        <div class="avatar-shape circle pink"></div>
                    </div>
                    <div class="avatar-option" data-shape="square" data-color="teal">
                        <div class="avatar-shape square teal"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="player-name">Your Name</label>
                    <input type="text" id="player-name" placeholder="Enter your name">
                </div>
                
                <div class="form-group">
                    <label for="world-description-text">Describe Your World</label>
                    <p class="description-help">Tell us what kind of world you want to create. Be creative!</p>
                    
                    <div class="chips">
                        <div class="chip" data-suggestion="A mountain landscape with tall trees and a river">Mountains</div>
                        <div class="chip" data-suggestion="A vast desert with sand dunes and oases">Desert</div>
                        <div class="chip" data-suggestion="A tropical island with beaches and palm trees">Island</div>
                        <div class="chip" data-suggestion="A dense forest with ancient trees and wildlife">Forest</div>
                        <div class="chip" data-suggestion="A blocky world with cubes and caves">Blocky</div>
                        <div class="chip" data-suggestion="A snowy landscape with ice mountains and frozen lakes">Snow</div>
                    </div>
                    
                    <div class="voice-input">
                        <textarea id="world-description-text" placeholder="Example: A mountain landscape with tall trees and a river"></textarea>
                        <button id="voice-input-btn" class="voice-btn">
                            <span>🎤</span>
                            <span class="tooltip">Click to speak</span>
                        </button>
                    </div>
                    
                    <div class="char-counter">
                        <span id="char-count">0</span>/200
                    </div>
                </div>
                
                <div class="form-actions">
                    <button id="back-from-create" class="btn">Back</button>
                    <button id="create-world-submit" class="btn btn-primary">Create World</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Selection Screen -->
    <div id="template-selection-screen" class="screen">
        <div class="container">
            <h1>Choose a World Template</h1>
            <p>Select a template to start with, then customize it to make it your own!</p>
            
            <div class="template-grid">
                <div class="template-card" data-template="blocky">
                    <div class="template-image blocky-world">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI0ZGNTcyMiIgZD0iTTQsNEgyMFYyMEg0VjRNNiw2VjEwSDEwVjZINk0xMiw2VjEwSDE2VjZIMTJNNiwxMlYxNkgxMFYxMkg2TTEyLDEyVjE2SDE2VjEySDEyWiIgLz48L3N2Zz4=" alt="Blocky World">
                    </div>
                    <div class="template-info">
                        <h3 class="template-title">Blocky World</h3>
                        <p class="template-description">A Minecraft-style world with blocks, caves, and mountains</p>
                    </div>
                </div>
                
                <div class="template-card" data-template="sky-defender">
                    <div class="template-image sky-defender">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2ZmZmZmZiIgZD0iTTIuNSwxOUgzLjVWMTdIMi41VjE5TTIyLDE4SDIwVjE3SDIyVjE4TTIsMTdIMVYxOEgyVjE3TTEzLDdWOUgxNFY3SDEzTTkuNSw3QzkuMiw3LjIsOSw3LjYsOSw4QzksOC40LDkuMiw4LjgsOS41LDlDOS44LDkuMiwxMC4yLDkuNSwxMC41LDkuNUMxMC44LDkuNSwxMS4yLDkuMiwxMS41LDlDMTEuOCw4LjgsMTIsOC40LDEyLDhDMTIsNy42LDExLjgsNy4yLDExLjUsN0MxMS4yLDYuOCwxMC44LDYuNSwxMC41LDYuNUM5LjgsNi41LDkuMiw2LjgsOS41LDdNMTUsMTBWOEgxNFYxMEgxM1YxMUgxNFYxM0gxNVYxMUgxNlYxMEgxNVpNMTMsMTJWMTFIMTJWMTJIMTNNMTMsMTNWMTJIMTJWMTNIMTNNMTMsMTRWMTNIMTJWMTRIMTNNMTMsMTVWMTRIMTJWMTVIMTNNMTMsMTZWMTVIMTJWMTZIMTNNMTMsMTdWMTZIMTJWMTdIMTNNOCwxMFY4SDdWMTBINlYxMUg3VjEzSDhWMTFIOVYxMEg4Wk0xMCwxM1YxMUg5VjEzSDEwTTEwLDE0VjEzSDlWMTRIMTBNMTAsMTVWMTRIOVYxNUgxME0xMCwxNlYxNUg5VjE2SDEwTTEwLDE3VjE2SDlWMTdIMTBNMjIsMTZWMTVIMjBWMTZIMjJNMjAsMTRIMTlWMTVIMjBWMTRNMjAsMTNIMTlWMTRIMjBWMTNNMjAsMTJIMTlWMTNIMjBWMTJNMjAsMTFIMTlWMTJIMjBWMTFNMjAsMTBIMTlWMTFIMjBWMTBNMjAsOUgxOVYxMEgyMFY5TTIwLDhIMTlWOUgyMFY4TTIwLDdIMTlWOEgyMFY3TTIwLDZIMTlWN0gyMFY2TTIwLDVIMTlWNkgyMFY1TTIwLDRIMTlWNUgyMFY0TTIwLDNIMTlWNEgyMFYzTTQsMTRIM1YxNUg0VjE0TTQsMTNIM1YxNEg0VjEzTTQsMTJIM1YxM0g0VjEyTTQsMTFIM1YxMkg0VjExTTQsMTBIM1YxMUg0VjEwTTQsOUgzVjEwSDRWOU00LDhIM1Y5SDRWOE00LDdIM1Y4SDRWNzRNNCw2SDNWNkg0VjZNNCw1SDNWNkg0VjVNNCw0SDNWNUg0VjRNNCwzSDNWNEg0VjNNNSwxOUg2VjE3SDVWMTlNOCwxOUg5VjE3SDhWMTlNMTEsMTlIMTJWMTdIMTFWMTlNMTQsMTlIMTVWMTdIMTRWMTlNMTcsMTlIMThWMTdIMTdWMTkiIC8+PC9zdmc+" alt="Sky Defender">
                    </div>
                    <div class="template-info">
                        <h3 class="template-title">Sky Defender</h3>
                        <p class="template-description">Fly an airplane and shoot down UFOs to protect the city</p>
                    </div>
                </div>
                
                <div class="template-card" data-template="speed-racers">
                    <div class="template-image speed-racers">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2ZmZmZmZiIgZD0iTTIxLDEwLjVMMTkuNSwxM0gxNy4xNUwxNS44NSwxMC41QzE1LjYyLDEwLjE0IDE1LjM4LDEwIDE1LDEwQzE0LjYyLDEwIDE0LjM4LDEwLjE0IDE0LjE1LDEwLjVMMTIuODUsMTNIMTAuNUw5LDEwLjVDOC43NiwxMC4xNCA4LjUsMTAgOCwxMEM3LjUsMTAgNy4yNCwxMC4xNCA3LDEwLjVMNS41LDEzSDNMMSwxMC41VjE1SDIzVjEwLjVIMjFNMjMsMTdIMVYxOUgyM1YxN1oiIC8+PC9zdmc+" alt="Speed Racers">
                    </div>
                    <div class="template-info">
                        <h3 class="template-title">Speed Racers</h3>
                        <p class="template-description">Race cars on exciting tracks with jumps and obstacles</p>
                    </div>
                </div>
                
                <div class="template-card" data-template="arcade-classic">
                    <div class="template-image arcade-classic">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2ZmZmZmZiIgZD0iTTIxLDZIMTVWNEgyMVY2TTIxLjY3LDIwLjgzTDIwLjQzLDIyLjA3TDE1LjIxLDE2Ljg1TDEzLjI1LDE4LjgxQzEzLjI1LDE4LjgxIDEzLDEzLjg3IDE4LDExLjVDMTgsMTEuNSAxNi4xLDExLjU3IDE1LDEyLjVMMTEuNzIsOS4yOEwxNS4yOSw1LjcxTDE0LDQuNDNMMTAuNDMsOEw5LjIsNi43OEwxMC41LDUuNUw5LjIyLDQuMjJMNy45Myw1LjVMNi43MSw0LjI5TDguNSwzTDcuMjEsMS43MUwzLjA4LDUuODNDMi44OCw2LjAzIDIuODgsNi4zNCAzLjA4LDYuNTRMMTcuNDYsMjAuOTJDMTcuNjYsMjEuMTIgMTcuOTcsMjEuMTIgMTguMTcsMjAuOTJMMjEuNjcsMTcuNDJDMjEuODcsMTcuMjIgMjEuODcsMTYuOTEgMjEuNjcsMTYuNzFMMTguMzYsMTMuNEwxOC4zNywxMy4zOUMxOC4zNywxMy4zOSAyMC45NCwxMy4zOSAyMi4wOSwxNi4wOEwyMy4xLDE3LjA5QzIzLjEsMTcuMDkgMjMuMTcsMTcuOTMgMjIuMjUsMTguOTVDMjIuMjUsMTguOTUgMjIuMjgsMTcuODcgMjEuNjcsMTcuNDJNNy40NiwxMy40MUMzLjY0LDEzLjY2IDIuODksMTcuOTcgMi44OSwxNy45N0MyLjg5LDE3Ljk3IDMuNzYsMTUuOTQgNS45MSwxNS45NEM4LjA2LDE1Ljk0IDguMzgsMTcuNTYgOC4zOSwxOS4yQzguNCwyMC44MyA3LjQ2LDIxLjQgNy40NiwyMS40QzcuNDYsMjEuNCA5LjU2LDIxLjQgOS41NiwxOC4zNkM5LjU2LDE1LjMyIDcuNDYsMTMuNDEgNy40NiwxMy40MVoiIC8+PC9zdmc+" alt="Arcade Classic">
                    </div>
                    <div class="template-info">
                        <h3 class="template-title">Arcade Classic</h3>
                        <p class="template-description">Play in a retro 80s arcade game with pixels and neon</p>
                    </div>
                </div>
                
                <div class="template-card" data-template="ocean-explorer">
                    <div class="template-image ocean-explorer">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2ZmZmZmZiIgZD0iTTIyLDEwVjEySDIwVjEwSDIyTTIsMTRWMTJINFYxNEgyTTEyLDIyVjIwSDE0VjIySDEyTTEyLDJWNEgxMFYySDEyTTIsMTBWOEg0VjEwSDJNMTYsMTRWMTJIMThWMTRIMTZNMTYsMjJWMjBIMThWMjJIMTZNMTYsMlY0SDE0VjJIMTZNNiwxNFYxMkg4VjE0SDZNNiwyMlYyMEg4VjIySDZNNiwyVjRINFYySDZNMTIsMTRWMTJIMTRWMTRIMTJNMTIsMTBWOEgxNFYxMEgxMk0yLDE4VjE2SDRWMThIMk0yLDIyVjIwSDRWMjJIMk0yLDZWNEg0VjZIMk0yMiwxNFYxNkgyMFYxNEgyMk0yMiwxOFYyMEgyMFYxOEgyMk0yMiw2VjhIMjBWNkgyMk0yMiwyVjRIMjBWMkgyMk0xNiwxMFY4SDE4VjEwSDE2TTE2LDZWNEgxOFY2SDE2TTE2LDE4VjE2SDE4VjE4SDE2TTYsMTBWOEg4VjEwSDZNNiwxOFYxNkg4VjE4SDZNNiw2VjRIOFY2SDZNMTIsMThWMTZIMTRWMThIMTJNMTIsNlY4SDEwVjZIMTJNNiwyMlYyMEg4VjIySDYiIC8+PC9zdmc+" alt="Ocean Explorer">
                    </div>
                    <div class="template-info">
                        <h3 class="template-title">Ocean Explorer</h3>
                        <p class="template-description">Dive into an underwater world with coral reefs and sea creatures</p>
                    </div>
                </div>
                
                <div class="template-card" data-template="galaxy-explorer">
                    <div class="template-image galaxy-explorer">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2ZmZmZmZiIgZD0iTTEyLDE1LjVBMy41LDMuNSAwIDAsMSA4LjUsMTJBMy41LDMuNSAwIDAsMSAxMiw4LjVBMy41LDMuNSAwIDAsMSAxNS41LDEyQTMuNSwzLjUgMCAwLDEgMTIsMTUuNU0xOSwyM0wxNS42NywxNS4yM0MxNi43NywxNC4zMSAxNy41LDEzLjIzIDE3LjUsMTJDMTcuNSw5LjQxIDE1LjA5LDcgMTIuNSw3SDExLjVWNUgxMi41QzE2LjE0LDUgMTkuNSw4LjM2IDE5LjUsMTJDMTkuNSwxMy43MSAxOC45MiwxNS4yNiAxNy43NywxNi41TDIwLDIyTDE5LDIzTTIsMTJDMiw4LjM2IDUuMzYsNSA5LDVIMTAuNVY3SDlDNi40MSw3IDQsOS40MSA0LDEyQzQsMTQuNjkgNi40MSwxNyA5LDE3SDEwLjVWMTlIOUMyLjM2LDE5IDIsMTIgMiwxMloiIC8+PC9zdmc+" alt="Galaxy Explorer">
                    </div>
                    <div class="template-info">
                        <h3 class="template-title">Galaxy Explorer</h3>
                        <p class="template-description">Explore outer space with planets, stars, and asteroids</p>
                    </div>
                </div>
            </div>
            
            <div class="template-actions">
                <button id="back-from-template" class="btn">Back</button>
                <button id="select-template" class="btn btn-primary">Select Template</button>
            </div>
        </div>
    </div>

    <!-- Join World Screen -->
    <div id="join-world-screen" class="screen">
        <div class="container">
            <h1>Join a Friend's World</h1>
            
            <div class="card">
                <div class="form-group">
                    <label for="player-name-join">Your Name</label>
                    <input type="text" id="player-name-join" placeholder="Enter your name">
                </div>
                
                <div class="form-group">
                    <label for="world-code">World Code</label>
                    <input type="text" id="world-code" placeholder="Enter 6-character code" maxlength="6">
                </div>
                
                <div class="form-actions">
                    <button id="back-from-join" class="btn">Back</button>
                    <button id="join-world-submit" class="btn btn-primary">Join World</button>
                </div>
            </div>
        </div>
    </div>

    <!-- World Creation Loading Screen -->
    <div id="world-creation-loading" class="screen">
        <div class="container">
            <div class="loading-container">
                <h2 class="loading-title">Creating Your World</h2>
                
                <div class="creation-steps">
                    <div class="step current">
                        <div class="step-icon">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2ZmZmZmZiIgZD0iTTIxLDdMOSwxOUwzLjUsMTMuNUw0LjkxLDEyLjA5TDksMTYuMTdMMTkuNTksNS41OUwyMSw3WiIgLz48L3N2Zz4=" alt="Analyzing">
                        </div>
                        <div class="step-content">
                            <div class="step-title">Analyzing your description</div>
                            <div class="step-description">Converting your words into Mandelbrot parameters</div>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-icon">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2ZmZmZmZiIgZD0iTTEyLDIwQTgsOCAwIDAsMSA0LDEyQTgsOCAwIDAsMSAxMiw0QTgsOCAwIDAsMSAyMCwxMkE4LDggMCAwLDEgMTIsMjBNMTIsMkExMCwxMCAwIDAsMCAyLDEyQTEwLDEwIDAgMCwwIDEyLDIyQTEwLDEwIDAgMCwwIDIyLDEyQTEwLDEwIDAgMCwwIDEyLDJaIiAvPjwvc3ZnPg==" alt="Generating">
                        </div>
                        <div class="step-content">
                            <div class="step-title">Generating terrain</div>
                            <div class="step-description">Creating mountains, valleys, and landscapes</div>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-icon">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2ZmZmZmZiIgZD0iTTEzLDJWNEMxNy40Miw0LjUgMjEsOC4yNCAyMSwxM0MyMSwxOC41IDE2LjUsMjMgMTEsMjNDNS41LDIzIDEsMTguNSAxLDEzQzEsOC4yNCA0LjU4LDQuNSA5LDRWMkM0LjAzLDIuNSAwLDcuMjUgMCwxM0MwLDE5LjA3IDQuOTMsMjQgMTEsMjRDMTcuMDcsMjQgMjIsMTkuMDcgMjIsMTNDMjIsNy4yNSAxNy45NywyLjUgMTMsMk0xMSw3VjEzTDE2LjI1LDE2LjE1TDE3LDE0LjkxTDEyLjUsMTIuMjVWN0gxMVoiIC8+PC9zdmc+" alt="Adding">
                        </div>
                        <div class="step-content">
                            <div class="step-title">Adding details</div>
                            <div class="step-description">Placing trees, rocks, and other objects</div>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-icon">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2ZmZmZmZiIgZD0iTTIwLDExVjEzSDhMMTMuNSwxOC41TDEyLjA4LDE5LjkyTDQuMTYsMTJMMTIuMDgsNC4wOEwxMy41LDUuNUw4LDExSDIwWiIgLz48L3N2Zz4=" alt="Finalizing">
                        </div>
                        <div class="step-content">
                            <div class="step-title">Finalizing world</div>
                            <div class="step-description">Preparing your world for exploration</div>
                        </div>
                    </div>
                </div>
                
                <div class="loading-bar-container">
                    <div class="loading-bar" style="width: 0%"></div>
                </div>
                
                <div class="loading-tip">
                    <strong>Tip:</strong> The Mandelbrot set creates infinite detail, so every world is unique!
                </div>
                
                <button id="cancel-creation" class="cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Game World Screen -->
    <div id="game-world" class="screen">
        <div class="game-container">
            <canvas id="mandelbrot-canvas" class="mandelbrot-canvas"></canvas>
            
            <div class="game-ui">
                <div class="world-info">
                    <h3 id="world-name">Your World</h3>
                    <div id="world-code">Code: <span>------</span></div>
                </div>
                
                <div id="menu-btn" class="menu-button">
                    <span>≡</span>
                </div>
            </div>
            
            <div id="game-menu" class="game-menu hidden">
                <div id="exit-game" class="menu-item">Exit to Main Menu</div>
                <div id="invite-friends" class="menu-item">Invite Friends</div>
            </div>
            
            <div class="player-list-container">
                <div class="player-list-header">Players</div>
                <div id="player-list"></div>
            </div>
            
            <div class="controls">
                <div id="zoom-in" class="control-btn">+</div>
                <div id="zoom-out" class="control-btn">-</div>
                <div id="reset-view" class="control-btn">↺</div>
            </div>
        </div>
    </div>

    <!-- Invite Modal -->
    <div id="invite-modal" class="modal hidden">
        <div class="modal-content">
            <h2 class="modal-title">Invite Friends</h2>
            <div class="modal-body">
                <p>Share this code with your friends so they can join your world:</p>
                <div id="invite-code" class="invite-code">------</div>
                <button id="copy-code" class="btn btn-primary">Copy Code</button>
            </div>
            <button id="close-invite" class="btn">Close</button>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="modal hidden">
        <div class="modal-content">
            <h2 class="modal-title">Oops!</h2>
            <div class="modal-body">
                <p id="error-message">Something went wrong.</p>
            </div>
            <button id="error-ok" class="btn btn-primary">OK</button>
        </div>
    </div>

    <script>
        // Global variables
        let currentScreen = 'loading-screen';
        let selectedAvatar = { shape: 'circle', color: 'red' };
        let playerName = '';
        let selectedTemplate = null;
        let mandelbrotCanvas = null;
        let mandelbrotCtx = null;
        let mandelbrotZoom = 1;
        let mandelbrotOffsetX = 0;
        let mandelbrotOffsetY = 0;
        let mandelbrotColorScheme = 0;
        let isDragging = false;
        let lastX = 0;
        let lastY = 0;
        let worldCode = generateWorldCode();

        // Initialize the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('MandelBro initializing...');
            
            // Set up event listeners
            setupEventListeners();
            
            // Show main menu after short delay
            setTimeout(() => {
                showScreen('main-menu');
            }, 1500);
        });

        /**
         * Set up event listeners for UI elements
         */
        function setupEventListeners() {
            // Main menu buttons
            document.getElementById('create-world-btn').addEventListener('click', () => {
                showScreen('create-world-screen');
            });
            
            document.getElementById('template-world-btn').addEventListener('click', () => {
                showScreen('template-selection-screen');
            });
            
            document.getElementById('join-world-btn').addEventListener('click', () => {
                showScreen('join-world-screen');
            });
            
            // Create world screen
            document.getElementById('back-from-create').addEventListener('click', () => {
                showScreen('main-menu');
            });
            
            document.getElementById('create-world-submit').addEventListener('click', () => {
                createWorld();
            });
            
            // Template selection screen
            document.getElementById('back-from-template').addEventListener('click', () => {
                showScreen('main-menu');
            });
            
            document.getElementById('select-template').addEventListener('click', () => {
                applySelectedTemplate();
            });
            
            // Template cards
            const templateCards = document.querySelectorAll('.template-card');
            templateCards.forEach(card => {
                card.addEventListener('click', () => {
                    // Remove selected class from all cards
                    templateCards.forEach(c => c.classList.remove('selected'));
                    
                    // Add selected class to clicked card
                    card.classList.add('selected');
                    
                    // Update selected template
                    selectedTemplate = card.getAttribute('data-template');
                    console.log('Selected template:', selectedTemplate);
                });
            });
            
            // Join world screen
            document.getElementById('back-from-join').addEventListener('click', () => {
                showScreen('main-menu');
            });
            
            document.getElementById('join-world-submit').addEventListener('click', () => {
                joinWorld();
            });
            
            // World creation loading screen
            document.getElementById('cancel-creation').addEventListener('click', () => {
                showScreen('create-world-screen');
            });
            
            // Avatar selection
            const avatarOptions = document.querySelectorAll('.avatar-option');
            avatarOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // Remove selected class from all options
                    avatarOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // Add selected class to clicked option
                    option.classList.add('selected');
                    
                    // Update selected avatar
                    selectedAvatar = {
                        shape: option.getAttribute('data-shape'),
                        color: option.getAttribute('data-color')
                    };
                    
                    console.log('Selected avatar:', selectedAvatar);
                });
            });
            
            // World description character counter
            const worldDescriptionText = document.getElementById('world-description-text');
            const charCount = document.getElementById('char-count');
            
            worldDescriptionText.addEventListener('input', () => {
                const count = worldDescriptionText.value.length;
                charCount.textContent = count;
            });
            
            // Suggestion chips
            const suggestionChips = document.querySelectorAll('.chip');
            suggestionChips.forEach(chip => {
                chip.addEventListener('click', () => {
                    const suggestion = chip.getAttribute('data-suggestion');
                    worldDescriptionText.value = suggestion;
                    
                    // Trigger input event to update character count
                    const event = new Event('input', { bubbles: true });
                    worldDescriptionText.dispatchEvent(event);
                });
            });
            
            // Voice input button
            const voiceInputBtn = document.getElementById('voice-input-btn');
            if (voiceInputBtn) {
                voiceInputBtn.addEventListener('click', () => {
                    startVoiceInput();
                });
            }
            
            // Game menu button
            const menuBtn = document.getElementById('menu-btn');
            if (menuBtn) {
                menuBtn.addEventListener('click', () => {
                    toggleGameMenu();
                });
            }
            
            // Exit game button
            const exitGameBtn = document.getElementById('exit-game');
            if (exitGameBtn) {
                exitGameBtn.addEventListener('click', () => {
                    exitGame();
                });
            }
            
            // Invite friends button
            const inviteFriendsBtn = document.getElementById('invite-friends');
            if (inviteFriendsBtn) {
                inviteFriendsBtn.addEventListener('click', () => {
                    showInviteModal();
                });
            }
            
            // Close invite modal button
            const closeInviteBtn = document.getElementById('close-invite');
            if (closeInviteBtn) {
                closeInviteBtn.addEventListener('click', () => {
                    hideInviteModal();
                });
            }
            
            // Copy code button
            const copyCodeBtn = document.getElementById('copy-code');
            if (copyCodeBtn) {
                copyCodeBtn.addEventListener('click', () => {
                    copyInviteCode();
                });
            }
            
            // Error modal OK button
            const errorOkBtn = document.getElementById('error-ok');
            if (errorOkBtn) {
                errorOkBtn.addEventListener('click', () => {
                    hideErrorModal();
                });
            }
            
            // Mandelbrot controls
            document.getElementById('zoom-in').addEventListener('click', () => {
                zoomMandelbrot(1.5);
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                zoomMandelbrot(0.667);
            });
            
            document.getElementById('reset-view').addEventListener('click', () => {
                resetMandelbrotView();
            });
            
            // Mandelbrot canvas mouse events
            const canvas = document.getElementById('mandelbrot-canvas');
            
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                lastX = e.clientX;
                lastY = e.clientY;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - lastX;
                    const deltaY = e.clientY - lastY;
                    
                    mandelbrotOffsetX += deltaX / mandelbrotZoom;
                    mandelbrotOffsetY += deltaY / mandelbrotZoom;
                    
                    lastX = e.clientX;
                    lastY = e.clientY;
                    
                    drawMandelbrot();
                }
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('mouseleave', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('dblclick', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) / mandelbrotZoom - mandelbrotOffsetX;
                const y = (e.clientY - rect.top) / mandelbrotZoom - mandelbrotOffsetY;
                
                mandelbrotOffsetX = -x * 2 + canvas.width / (2 * mandelbrotZoom);
                mandelbrotOffsetY = -y * 2 + canvas.height / (2 * mandelbrotZoom);
                
                mandelbrotZoom *= 2;
                
                drawMandelbrot();
            });
            
            // Touch events for mobile
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDragging = true;
                lastX = e.touches[0].clientX;
                lastY = e.touches[0].clientY;
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (isDragging) {
                    const deltaX = e.touches[0].clientX - lastX;
                    const deltaY = e.touches[0].clientY - lastY;
                    
                    mandelbrotOffsetX += deltaX / mandelbrotZoom;
                    mandelbrotOffsetY += deltaY / mandelbrotZoom;
                    
                    lastX = e.touches[0].clientX;
                    lastY = e.touches[0].clientY;
                    
                    drawMandelbrot();
                }
            });
            
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                isDragging = false;
            });
            
            // Color scheme change on click
            canvas.addEventListener('click', () => {
                mandelbrotColorScheme = (mandelbrotColorScheme + 1) % 5;
                drawMandelbrot();
            });
        }

        /**
         * Show a specific screen
         * @param {string} screenId - ID of the screen to show
         */
        function showScreen(screenId) {
            // Hide all screens
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show requested screen
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.classList.add('active');
                currentScreen = screenId;
                
                // Special handling for specific screens
                if (screenId === 'create-world-screen') {
                    // Select first avatar by default if none selected
                    if (!document.querySelector('.avatar-option.selected')) {
                        document.querySelector('.avatar-option').classList.add('selected');
                    }
                } else if (screenId === 'game-world') {
                    // Initialize Mandelbrot canvas
                    initializeMandelbrotCanvas();
                }
                
                console.log('Showing screen:', screenId);
            }
        }

        /**
         * Apply the selected template
         */
        function applySelectedTemplate() {
            if (!selectedTemplate) {
                showError('Please select a template');
                return;
            }
            
            // Get template description
            let description = '';
            
            switch (selectedTemplate) {
                case 'blocky':
                    description = 'A Minecraft-style world with blocks, caves, and mountains';
                    break;
                case 'sky-defender':
                    description = 'Fly an airplane and shoot down UFOs to protect the city';
                    break;
                case 'speed-racers':
                    description = 'Race cars on exciting tracks with jumps and obstacles';
                    break;
                case 'arcade-classic':
                    description = 'Play in a retro 80s arcade game with pixels and neon';
                    break;
                case 'ocean-explorer':
                    description = 'Dive into an underwater world with coral reefs and sea creatures';
                    break;
                case 'galaxy-explorer':
                    description = 'Explore outer space with planets, stars, and asteroids';
                    break;
            }
            
            // Go to create world screen
            showScreen('create-world-screen');
            
            // Set description
            document.getElementById('world-description-text').value = description;
            
            // Trigger input event to update character count
            const event = new Event('input', { bubbles: true });
            document.getElementById('world-description-text').dispatchEvent(event);
        }

        /**
         * Create a new world
         */
        function createWorld() {
            // Get player name
            playerName = document.getElementById('player-name').value.trim();
            if (!playerName) {
                showError('Please enter your name');
                return;
            }
            
            // Get world description
            const worldDescription = document.getElementById('world-description-text').value.trim();
            if (!worldDescription) {
                showError('Please describe your world');
                return;
            }
            
            // Show loading screen
            showScreen('world-creation-loading');
            
            // Simulate world creation process
            simulateWorldCreation(worldDescription);
        }

        /**
         * Simulate world creation process
         * @param {string} description - World description
         */
        function simulateWorldCreation(description) {
            // Update step 1
            updateCreationStep(0);
            
            // Simulate step 1 completion
            setTimeout(() => {
                // Update step 2
                updateCreationStep(1);
                
                // Simulate step 2 completion
                setTimeout(() => {
                    // Update step 3
                    updateCreationStep(2);
                    
                    // Simulate step 3 completion
                    setTimeout(() => {
                        // Update step 4
                        updateCreationStep(3);
                        
                        // Simulate step 4 completion
                        setTimeout(() => {
                            // Generate world code
                            worldCode = generateWorldCode();
                            
                            // Show game world
                            showGameWorld(description);
                        }, 1000);
                    }, 1000);
                }, 1000);
            }, 1000);
        }

        /**
         * Join an existing world
         */
        function joinWorld() {
            // Get player name
            playerName = document.getElementById('player-name-join').value.trim();
            if (!playerName) {
                showError('Please enter your name');
                return;
            }
            
            // Get world code
            const code = document.getElementById('world-code').value.trim().toUpperCase();
            if (!code || code.length !== 6) {
                showError('Please enter a valid 6-character world code');
                return;
            }
            
            // Show loading screen
            showScreen('world-creation-loading');
            
            // Simulate joining world
            simulateJoiningWorld(code);
        }

        /**
         * Simulate joining world
         * @param {string} code - World code
         */
        function simulateJoiningWorld(code) {
            // Update step 1
            updateCreationStep(0);
            
            // Simulate step 1 completion
            setTimeout(() => {
                // Update step 2
                updateCreationStep(1);
                
                // Simulate step 2 completion
                setTimeout(() => {
                    // Update step 3
                    updateCreationStep(2);
                    
                    // Simulate step 3 completion
                    setTimeout(() => {
                        // Update step 4
                        updateCreationStep(3);
                        
                        // Simulate step 4 completion
                        setTimeout(() => {
                            // Set world code
                            worldCode = code;
                            
                            // Show game world
                            showGameWorld('Joined world');
                        }, 1000);
                    }, 1000);
                }, 1000);
            }, 1000);
        }

        /**
         * Update creation step
         * @param {number} stepIndex - Index of the current step
         */
        function updateCreationStep(stepIndex) {
            const steps = document.querySelectorAll('.creation-steps .step');
            
            // Update step classes
            steps.forEach((step, index) => {
                if (index < stepIndex) {
                    step.classList.remove('current');
                    step.classList.add('completed');
                } else if (index === stepIndex) {
                    step.classList.remove('completed');
                    step.classList.add('current');
                } else {
                    step.classList.remove('current', 'completed');
                }
            });
            
            // Update loading bar
            const progress = (stepIndex / (steps.length - 1)) * 100;
            document.querySelector('.loading-bar').style.width = `${progress}%`;
        }

        /**
         * Show the game world
         * @param {string} description - World description
         */
        function showGameWorld(description) {
            // Show game world screen
            showScreen('game-world');
            
            // Update world info
            document.getElementById('world-name').textContent = `${playerName}'s World`;
            document.querySelector('#world-code span').textContent = worldCode;
            
            // Add player to list
            addPlayerToList({
                id: 'player-1',
                name: playerName,
                avatar: selectedAvatar
            });
            
            console.log('Showing game world:', description);
        }

        /**
         * Initialize Mandelbrot canvas
         */
        function initializeMandelbrotCanvas() {
            mandelbrotCanvas = document.getElementById('mandelbrot-canvas');
            mandelbrotCtx = mandelbrotCanvas.getContext('2d');
            
            // Set canvas size
            mandelbrotCanvas.width = mandelbrotCanvas.parentElement.clientWidth;
            mandelbrotCanvas.height = mandelbrotCanvas.parentElement.clientHeight;
            
            // Reset view
            resetMandelbrotView();
            
            // Draw initial Mandelbrot
            drawMandelbrot();
        }

        /**
         * Reset Mandelbrot view
         */
        function resetMandelbrotView() {
            mandelbrotZoom = 1;
            mandelbrotOffsetX = 0;
            mandelbrotOffsetY = 0;
            drawMandelbrot();
        }

        /**
         * Zoom Mandelbrot
         * @param {number} factor - Zoom factor
         */
        function zoomMandelbrot(factor) {
            mandelbrotZoom *= factor;
            drawMandelbrot();
        }

        /**
         * Draw Mandelbrot set
         */
        function drawMandelbrot() {
            if (!mandelbrotCanvas || !mandelbrotCtx) return;
            
            const width = mandelbrotCanvas.width;
            const height = mandelbrotCanvas.height;
            const imageData = mandelbrotCtx.createImageData(width, height);
            const data = imageData.data;
            
            // Calculate Mandelbrot set
            for (let x = 0; x < width; x++) {
                for (let y = 0; y < height; y++) {
                    // Convert pixel coordinates to complex plane
                    const real = (x / mandelbrotZoom - width / 2 / mandelbrotZoom - mandelbrotOffsetX) * 4 / width;
                    const imag = (y / mandelbrotZoom - height / 2 / mandelbrotZoom - mandelbrotOffsetY) * 4 / height;
                    
                    // Calculate iterations
                    const iterations = calculateMandelbrot(real, imag, 100);
                    
                    // Set pixel color
                    const pixelIndex = (y * width + x) * 4;
                    const color = getColor(iterations, 100);
                    
                    data[pixelIndex] = color.r;
                    data[pixelIndex + 1] = color.g;
                    data[pixelIndex + 2] = color.b;
                    data[pixelIndex + 3] = 255; // Alpha
                }
            }
            
            // Draw image data
            mandelbrotCtx.putImageData(imageData, 0, 0);
        }

        /**
         * Calculate Mandelbrot iterations
         * @param {number} real - Real part of complex number
         * @param {number} imag - Imaginary part of complex number
         * @param {number} maxIterations - Maximum iterations
         * @returns {number} - Number of iterations
         */
        function calculateMandelbrot(real, imag, maxIterations) {
            let zReal = 0;
            let zImag = 0;
            let iteration = 0;
            
            while (zReal * zReal + zImag * zImag < 4 && iteration < maxIterations) {
                const nextZReal = zReal * zReal - zImag * zImag + real;
                const nextZImag = 2 * zReal * zImag + imag;
                
                zReal = nextZReal;
                zImag = nextZImag;
                
                iteration++;
            }
            
            return iteration;
        }

        /**
         * Get color based on iterations
         * @param {number} iterations - Number of iterations
         * @param {number} maxIterations - Maximum iterations
         * @returns {Object} - RGB color
         */
        function getColor(iterations, maxIterations) {
            if (iterations === maxIterations) {
                return { r: 0, g: 0, b: 0 };
            }
            
            // Different color schemes
            switch (mandelbrotColorScheme) {
                case 0: // Rainbow
                    const hue = iterations / maxIterations * 360;
                    return hslToRgb(hue, 1, 0.5);
                
                case 1: // Blue-Purple
                    const hue1 = 240 + iterations / maxIterations * 60;
                    return hslToRgb(hue1, 1, 0.5);
                
                case 2: // Green-Yellow
                    const hue2 = 60 + iterations / maxIterations * 60;
                    return hslToRgb(hue2, 1, 0.5);
                
                case 3: // Red-Orange
                    const hue3 = iterations / maxIterations * 60;
                    return hslToRgb(hue3, 1, 0.5);
                
                case 4: // Grayscale
                    const value = iterations / maxIterations * 255;
                    return { r: value, g: value, b: value };
            }
        }

        /**
         * Convert HSL to RGB
         * @param {number} h - Hue (0-360)
         * @param {number} s - Saturation (0-1)
         * @param {number} l - Lightness (0-1)
         * @returns {Object} - RGB color
         */
        function hslToRgb(h, s, l) {
            h /= 360;
            
            let r, g, b;
            
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            
            return {
                r: Math.round(r * 255),
                g: Math.round(g * 255),
                b: Math.round(b * 255)
            };
        }

        /**
         * Add player to the player list
         * @param {Object} player - Player data
         */
        function addPlayerToList(player) {
            const playerList = document.getElementById('player-list');
            
            // Check if player already exists
            const existingPlayer = document.getElementById(`player-${player.id}`);
            if (existingPlayer) {
                return;
            }
            
            // Create player item
            const playerItem = document.createElement('div');
            playerItem.id = `player-${player.id}`;
            playerItem.className = 'player-item';
            
            // Create avatar
            const avatar = document.createElement('div');
            avatar.className = `player-avatar ${player.avatar.shape} ${player.avatar.color}`;
            
            // Create name
            const name = document.createElement('div');
            name.className = 'player-name';
            name.textContent = player.name || 'Anonymous';
            
            // Add to player item
            playerItem.appendChild(avatar);
            playerItem.appendChild(name);
            
            // Add to player list
            playerList.appendChild(playerItem);
        }

        /**
         * Toggle game menu
         */
        function toggleGameMenu() {
            const gameMenu = document.getElementById('game-menu');
            gameMenu.classList.toggle('hidden');
        }

        /**
         * Exit game
         */
        function exitGame() {
            // Hide game menu
            document.getElementById('game-menu').classList.add('hidden');
            
            // Show main menu
            showScreen('main-menu');
        }

        /**
         * Show invite modal
         */
        function showInviteModal() {
            // Update invite code
            document.getElementById('invite-code').textContent = worldCode;
            
            // Show modal
            document.getElementById('invite-modal').classList.remove('hidden');
            
            // Hide game menu
            document.getElementById('game-menu').classList.add('hidden');
        }

        /**
         * Hide invite modal
         */
        function hideInviteModal() {
            document.getElementById('invite-modal').classList.add('hidden');
        }

        /**
         * Copy invite code to clipboard
         */
        function copyInviteCode() {
            const inviteCode = document.getElementById('invite-code').textContent;
            
            // Copy to clipboard
            navigator.clipboard.writeText(inviteCode).then(() => {
                // Show success message
                const copyBtn = document.getElementById('copy-code');
                const originalText = copyBtn.textContent;
                
                copyBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy code:', err);
            });
        }

        /**
         * Show error modal
         * @param {string} message - Error message
         */
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-modal').classList.remove('hidden');
        }

        /**
         * Hide error modal
         */
        function hideErrorModal() {
            document.getElementById('error-modal').classList.add('hidden');
        }

        /**
         * Start voice input
         */
        function startVoiceInput() {
            // Check if browser supports speech recognition
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showError('Voice input is not supported in your browser');
                return;
            }
            
            // Create speech recognition object
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            // Start recognition
            recognition.start();
            
            // Show recording indicator
            const voiceBtn = document.getElementById('voice-input-btn');
            voiceBtn.classList.add('recording');
            voiceBtn.querySelector('.tooltip').textContent = 'Listening...';
            
            // Handle result
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('world-description-text').value = transcript;
                
                // Trigger input event to update character count
                const inputEvent = new Event('input', { bubbles: true });
                document.getElementById('world-description-text').dispatchEvent(inputEvent);
                
                // Reset button
                voiceBtn.classList.remove('recording');
                voiceBtn.querySelector('.tooltip').textContent = 'Click to speak';
            };
            
            // Handle errors
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                
                // Reset button
                voiceBtn.classList.remove('recording');
                voiceBtn.querySelector('.tooltip').textContent = 'Click to speak';
                
                // Show error
                if (event.error === 'not-allowed') {
                    showError('Microphone access denied. Please allow microphone access to use voice input.');
                } else {
                    showError('Voice input error: ' + event.error);
                }
            };
            
            // Handle end
            recognition.onend = () => {
                // Reset button
                voiceBtn.classList.remove('recording');
                voiceBtn.querySelector('.tooltip').textContent = 'Click to speak';
            };
        }

        /**
         * Generate world code
         * @returns {string} - World code
         */
        function generateWorldCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            return code;
        }

        // Add window resize handler for canvas
        window.addEventListener('resize', () => {
            if (mandelbrotCanvas && currentScreen === 'game-world') {
                mandelbrotCanvas.width = mandelbrotCanvas.parentElement.clientWidth;
                mandelbrotCanvas.height = mandelbrotCanvas.parentElement.clientHeight;
                
                // Redraw canvas
                drawMandelbrot();
            }
        });
    </script>
</body>
</html>
